<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Trang ch·ªß</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

<header class="bg-primary text-white py-3 px-4 d-flex justify-content-between align-items-center">
    <h1 class="h3 mb-0">üçü SnackShop</h1>
    <nav>
        {% if tenDangNhap %}
        <a href="/giohang" class="text-white me-3">Gi·ªè h√†ng</a>
        <a href="/lich-su-don-hang" class="text-white me-3">L·ªãch s·ª≠ mua h√†ng</a>
        <a href="/logout" class="text-white">ƒêƒÉng xu·∫•t</a>
        {% else %}
        <a href="/login" class="text-white">ƒêƒÉng nh·∫≠p</a>
        {% endif %}
    </nav>
</header>

<main class="container mt-4">
    {% if tenDangNhap %}
    <div class="mb-4">
        <h4>Xin ch√†o, <strong>{{ hoTen }}</strong>!</h4>
        <span class="badge bg-success">Vai tr√≤: {{ vaiTro }}</span>
    </div>
    {% else %}
    {% endif %}

    <!-- Form t√¨m ki·∫øm -->
    <form method="get" class="row g-2 align-items-end mb-4" id="searchForm">
        <div class="col-md-6">
            <label for="keyword" class="form-label">T√¨m m√≥n ƒÉn</label>
            <input type="text" name="keyword" id="keyword" class="form-control"
                   placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." value="{{ keyword }}">
        </div>
        <div class="col-md-4">
            <label for="category_id" class="form-label">Danh m·ª•c</label>
            <select name="category_id" id="category_id" class="form-select">
                <option value="">-- T·∫•t c·∫£ --</option>
                {% for cat in danhMucList %}
                <option value="{{ cat.maDanhMuc }}" {% if category_id== cat.maDanhMuc|string %}selected{% endif %}>
                    {{ cat.tenDanhMuc }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">T√¨m ki·∫øm</button>
        </div>
    </form>

    <!-- Th√™m script x·ª≠ l√Ω -->
    <script>
        document.getElementById('category_id').addEventListener('change', function () {
            const keyword = document.getElementById('keyword').value.trim();
            if (keyword === '') {
                // N·∫øu ch∆∞a nh·∫≠p t·ª´ kh√≥a th√¨ t·ª± ƒë·ªông submit form
                document.getElementById('searchForm').submit();
            }
            // N·∫øu ƒë√£ nh·∫≠p t·ª´ kh√≥a, ng∆∞·ªùi d√πng ph·∫£i nh·∫•n n√∫t t√¨m ki·∫øm
        });
    </script>

    {% if best_sellers %}
    <div class="mb-4">
        <h4 class="mb-3">üî• S·∫£n ph·∫©m b√°n ch·∫°y</h4>
        <div class="row">
            {% for sp in best_sellers %}
            <div class="col-md-2 col-6 mb-3">
                <div class="card h-100">
                    <img src="{{ url_for('static', filename=sp.diaChiAnh) }}" class="card-img-top"
                         alt="{{ sp.tenSanPham }}">
                    <div class="card-body p-2">
                        <h6 class="card-title text-truncate">{{ sp.tenSanPham }}</h6>

                        <!-- Sao -->
                        {% set full_stars = sp.trungBinhSao | int %}
                        {% set half_star = 1 if (sp.trungBinhSao - full_stars) >= 0.5 else 0 %}
                        {% set empty_stars = 5 - full_stars - half_star %}
                        {% for i in range(full_stars) %}
                        <i class="bi bi-star-fill text-warning"></i>
                        {% endfor %}
                        {% if half_star %}
                        <i class="bi bi-star-half text-warning"></i>
                        {% endif %}
                        {% for i in range(empty_stars) %}
                        <i class="bi bi-star text-warning"></i>
                        {% endfor %}

                        <p class="text-danger fw-bold mb-1">{{ "{:,}".format(sp.gia | int) }} ƒë</p>
                        <a href="/product/{{ sp.maSanPham }}" class="btn btn-sm btn-outline-primary w-100">Xem</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    {% if sanPhamList %}
    <div class="row">
        <h4 class="mb-3">T·∫•t c·∫£ s·∫£n ph·∫©m</h4>
        {% for sp in sanPhamList %}
        <div class="col-md-3 mb-4">
            <div class="card h-100">
                <img src="{{ url_for('static', filename=sp.diaChiAnh) }}" class="card-img-top"
                     alt="{{ sp.tenSanPham }}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ sp.tenSanPham }}</h5>

                    <!-- Hi·ªÉn th·ªã trung b√¨nh sao -->
                    <div class="mb-2">
                        {% set full_stars = sp.trungBinhSao | int %}
                        {% set half_star = 1 if (sp.trungBinhSao - full_stars) >= 0.5 else 0 %}
                        {% set empty_stars = 5 - full_stars - half_star %}

                        {% for i in range(full_stars) %}
                        <i class="bi bi-star-fill text-warning"></i>
                        {% endfor %}
                        {% if half_star %}
                        <i class="bi bi-star-half text-warning"></i>
                        {% endif %}
                        {% for i in range(empty_stars) %}
                        <i class="bi bi-star text-warning"></i>
                        {% endfor %}

                        <small class="text-muted">({{ sp.trungBinhSao }}/5)</small>
                    </div>

                    <p class="card-text">{{ "{:,}".format(sp.gia | int) }} ƒë</p>

                    <div class="mt-auto">
                        <a href="/product/{{ sp.maSanPham }}" class="btn btn-sm btn-outline-primary w-100 mb-2">Xem chi
                            ti·∫øt</a>
                        <div class="d-flex justify-content-between gap-2 product-{{ sp.maSanPham }}">
                            <form action="/them_gio_hang" method="post"
                                  class="flex-fill d-flex gap-2 align-items-center">
                                <input type="hidden" name="product_id" value="{{ sp.maSanPham }}">
                                <input type="number" name="quantity" class="form-control" value="1" min="1"
                                       style="width: 80px;">
                                <button type="submit" class="btn btn-sm btn-success w-100">üõí Th√™m</button>
                            </form>

                            <form action="/mua_ngay" method="post" class="flex-fill d-flex gap-2 align-items-center">
                                <input type="hidden" name="product_id" value="{{ sp.maSanPham }}">
                                <input type="number" name="quantity" class="form-control" value="1" min="1"
                                       style="width: 80px;">
                                <button type="submit" class="btn btn-sm btn-danger w-100">‚ö° Mua</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- Ph√¢n trang -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link"
                   href="?keyword={{ keyword }}&category_id={{ category_id }}&page={{ current_page - 1 }}">Tr∆∞·ªõc</a>
            </li>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if current_page == p %}active{% endif %}">
                <a class="page-link" href="?keyword={{ keyword }}&category_id={{ category_id }}&page={{ p }}">{{ p
                    }}</a>
            </li>
            {% endfor %}
            {% if current_page < total_pages %}
            <li class="page-item">
                <a class="page-link"
                   href="?keyword={{ keyword }}&category_id={{ category_id }}&page={{ current_page + 1 }}">Ti·∫øp</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% else %}
    <div class="alert alert-warning text-center">
        Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p!
    </div>
    {% endif %}
</main>

</body>
</html>
