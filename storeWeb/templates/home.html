{% extends "base.html" %}

{% block title %}Trang ch·ªß{% endblock %}

{% block content %}

    <!-- Form t√¨m ki·∫øm -->
    <div class="card shadow-sm p-3 mb-4">
        <form method="get" class="row g-3 align-items-end" id="searchForm">
            <div class="col-md-6">
                <label for="keyword" class="form-label fw-semibold">üîç T√¨m m√≥n ƒÉn</label>
                <input type="text" name="keyword" id="keyword" class="form-control"
                       placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." value="{{ keyword }}">
            </div>
            <div class="col-md-4">
                <label for="category_id" class="form-label fw-semibold">üìÇ Danh m·ª•c</label>
                <select name="category_id" id="category_id" class="form-select">
                    <option value="">-- T·∫•t c·∫£ --</option>
                    {% for cat in danhMucList %}
                    <option value="{{ cat.maDanhMuc }}" {% if category_id== cat.maDanhMuc|string %}selected{% endif %}>
                        {{ cat.tenDanhMuc }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary fw-semibold">
                    <i class="bi bi-search"></i> T√¨m ki·∫øm
                </button>
            </div>
        </form>
    </div>

    <script>
        document.getElementById('category_id').addEventListener('change', function () {
            const keyword = document.getElementById('keyword').value.trim();
            if (keyword === '') {
                document.getElementById('searchForm').submit();
            }
        });
    </script>

    {% if best_sellers %}
<div class="mb-5">
    <h4 class="mb-3 fw-bold text-danger">üî• S·∫£n ph·∫©m b√°n ch·∫°y</h4>

    <div id="bestSellersCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
    <div class="carousel-inner">

        {% for i in range(0, best_sellers|length, 6) %}
<div class="carousel-item {% if i == 0 %}active{% endif %}">
    <div class="row justify-content-center">
        {% for sp in best_sellers[i:i+6] %}
        <div class="col-md-2 col-6"> <!-- 12 / 6 = 2 c·ªôt -->
            <div class="card shadow-sm border-0 h-100">
                <img src="{{ sp.diaChiAnh }}" class="card-img-top rounded-top"
                     alt="{{ sp.tenSanPham }}" style="height:120px;object-fit:cover;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title text-truncate fw-semibold">{{ sp.tenSanPham }}</h6>

                    <!-- sao -->
                    <div class="mb-1">
                        {% set full_stars = sp.trungBinhSao | int %}
                        {% set half_star = 1 if (sp.trungBinhSao - full_stars) >= 0.5 else 0 %}
                        {% set empty_stars = 5 - full_stars - half_star %}
                        {% for i in range(full_stars) %}<i class="bi bi-star-fill text-warning"></i>{% endfor %}
                        {% if half_star %}<i class="bi bi-star-half text-warning"></i>{% endif %}
                        {% for i in range(empty_stars) %}<i class="bi bi-star text-warning"></i>{% endfor %}
                    </div>

                    <p class="text-danger fw-bold mb-2">{{ "{:,}".format(sp.gia | int) }} ƒë</p>
                    <a href="/product/{{ sp.maSanPham }}" class="btn btn-sm btn-outline-primary w-100">Xem</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
    </div>

    <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
    <button class="carousel-control-prev" type="button" data-bs-target="#bestSellersCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#bestSellersCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</div>
</div>
{% endif %}

    {% if sanPhamList %}
    <div class="row">
        <h4 class="mb-3 fw-bold">üõí T·∫•t c·∫£ s·∫£n ph·∫©m</h4>
        {% for sp in sanPhamList %}
        <div class="col-md-3 col-6 mb-4">
            <div class="card h-100 shadow-sm border-0 hover-scale">
                <img src="{{ sp.diaChiAnh }}" class="card-img-top rounded-top"
                     alt="{{ sp.tenSanPham }}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-semibold">{{ sp.tenSanPham }}</h5>

                    <!-- ƒë√°nh gi√° -->
                    <div class="mb-2">
                        {% set full_stars = sp.trungBinhSao | int %}
                        {% set half_star = 1 if (sp.trungBinhSao - full_stars) >= 0.5 else 0 %}
                        {% set empty_stars = 5 - full_stars - half_star %}
                        {% for i in range(full_stars) %}<i class="bi bi-star-fill text-warning"></i>{% endfor %}
                        {% if half_star %}<i class="bi bi-star-half text-warning"></i>{% endif %}
                        {% for i in range(empty_stars) %}<i class="bi bi-star text-warning"></i>{% endfor %}
                        <small class="text-muted">({{ sp.trungBinhSao }}/5)</small>
                    </div>

                    <p class="card-text text-danger fw-bold">{{ "{:,}".format(sp.gia | int) }} ƒë</p>

                    <div class="mt-auto">
                        <a href="/product/{{ sp.maSanPham }}" class="btn btn-sm btn-outline-primary w-100 mb-2">
                            Xem chi ti·∫øt
                        </a>
                        <div class="d-flex gap-2">
                            <form action="/them_gio_hang" method="post" class="flex-fill d-flex gap-2 align-items-center">
                                <input type="hidden" name="product_id" value="{{ sp.maSanPham }}">
                                <input type="number" name="quantity" class="form-control form-control-sm" value="1" min="1" style="width: 70px;">
                                <button type="submit" class="btn btn-sm btn-success w-100">üõí</button>
                            </form>
                            <form action="/mua_ngay" method="post" class="flex-fill d-flex gap-2 align-items-center">
                                <input type="hidden" name="product_id" value="{{ sp.maSanPham }}">
                                <input type="number" name="quantity" class="form-control form-control-sm" value="1" min="1" style="width: 70px;">
                                <button type="submit" class="btn btn-sm btn-danger w-100">‚ö°</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
            {% if current_page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?keyword={{ keyword }}&category_id={{ category_id }}&page={{ current_page - 1 }}">¬´ Tr∆∞·ªõc</a>
            </li>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if current_page == p %}active{% endif %}">
                <a class="page-link" href="?keyword={{ keyword }}&category_id={{ category_id }}&page={{ p }}">{{ p }}</a>
            </li>
            {% endfor %}
            {% if current_page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="?keyword={{ keyword }}&category_id={{ category_id }}&page={{ current_page + 1 }}">Ti·∫øp ¬ª</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% else %}
    <div class="alert alert-warning text-center shadow-sm">üò¢ Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o ph√π h·ª£p!</div>
    {% endif %}

    <!-- style ri√™ng -->
    <style>
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        .hover-scale:hover {
            transform: scale(1.03);
        }
    </style>
{% endblock %}
