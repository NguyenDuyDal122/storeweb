{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">üì¶ L·ªãch s·ª≠ mua h√†ng c·ªßa b·∫°n</h2>

    {% if don_hangs %}
    {% for dh in don_hangs %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between flex-wrap">
            <div class="mb-1">
                <strong>M√£ ƒë∆°n h√†ng:</strong> {{ dh.maDonHang }} |
                <strong>Ng√†y t·∫°o:</strong> {{ dh.ngaytao }}
            </div>
            <div>
                <span class="badge
                    {% if dh.trangThai == 'pending' %}bg-warning text-dark{% endif %}
                    {% if dh.trangThai == 'confirmed' %}bg-primary{% endif %}
                    {% if dh.trangThai == 'shipped' %}bg-success{% endif %}
                    {% if dh.trangThai == 'cancelled' %}bg-danger{% endif %}
                    badge-status">
                    {{ dh.trangThai|capitalize }}
                </span>
                <strong class="ms-3">T·ªïng gi√°:</strong> {{ "{:,}".format(dh.tongGia|int) }} ƒë
            </div>
        </div>
        <div class="card-body p-3">
            <div class="table-responsive">
                <table class="table table-hover table-bordered mb-0">
                    <thead>
                    <tr>
                        <th>S·∫£n ph·∫©m</th>
                        <th class="text-center">S·ªë l∆∞·ª£ng</th>
                        <th class="text-end">Gi√°</th>
                        <th class="text-end">Th√†nh ti·ªÅn</th>
                        <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for ct in dh.chi_tiet %}
                    <tr>
                        <td>{{ ct.tenSanPham }}</td>
                        <td class="text-center">{{ ct.soLuong }}</td>
                        <td class="text-end">{{ "{:,}".format(ct.gia|int) }} ƒë</td>
                        <td class="text-end">{{ "{:,}".format(ct.gia * ct.soLuong|int) }} ƒë</td>
                        <td class="text-center">
                            {% if not ct.daDanhGia %}
                            <button class="btn btn-sm btn-outline-primary btn-danh-gia"
                                    type="button"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalDanhGia"
                                    data-masanpham="{{ ct.maSanPham }}"
                                    data-tensanpham="{{ ct.tenSanPham }}"
                                    data-machitietdonhang="{{ ct.maChiTietDonHang }}">
                                ƒê√°nh gi√°
                            </button>
                            {% else %}
                            <span class="text-success">‚úî ƒê√£ ƒë√°nh gi√°</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-warning text-center shadow-sm">B·∫°n ch∆∞a ƒë·∫∑t ƒë∆°n h√†ng n√†o!</div>
    {% endif %}
</div>

<!-- Modal ƒë√°nh gi√° -->
<div class="modal fade" id="modalDanhGia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="/danh-gia" id="formDanhGia" class="w-100">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">‚≠ê ƒê√°nh gi√° s·∫£n ph·∫©m</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="maSanPham" id="inputMaSanPham" required>
                    <input type="hidden" name="maChiTietDonHang" id="inputMaChiTietDonHang" required>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">S·∫£n ph·∫©m</label>
                        <input type="text" id="inputTenSanPham" class="form-control bg-light fw-bold" disabled>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ch·ªçn s·ªë sao</label>
                        <div class="star-rating fs-3" style="cursor:pointer;">
                            <i class="bi bi-star" data-value="1"></i>
                            <i class="bi bi-star" data-value="2"></i>
                            <i class="bi bi-star" data-value="3"></i>
                            <i class="bi bi-star" data-value="4"></i>
                            <i class="bi bi-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="danhGia" id="inputDanhGia" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">B√¨nh lu·∫≠n</label>
                        <textarea name="binhLuan" class="form-control" rows="3"
                                  placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success px-4">G·ª≠i ƒë√°nh gi√°</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
    const modalDanhGia = document.getElementById('modalDanhGia');
    const formDanhGia = document.getElementById('formDanhGia');

    modalDanhGia.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const maSanPham = button.getAttribute('data-masanpham');
        const tenSanPham = button.getAttribute('data-tensanpham');
        const maChiTietDonHang = button.getAttribute('data-machitietdonhang');

        document.getElementById('inputMaSanPham').value = maSanPham || '';
        document.getElementById('inputTenSanPham').value = tenSanPham || '';
        document.getElementById('inputMaChiTietDonHang').value = maChiTietDonHang || '';

        document.getElementById('inputDanhGia').value = '';
        document.querySelectorAll('.star-rating i').forEach(s => {
            s.classList.remove('bi-star-fill', 'text-warning');
            s.classList.add('bi-star');
        });
    });

    formDanhGia.addEventListener('submit', function (e) {
        const maSP = document.getElementById('inputMaSanPham').value.trim();
        const maCT = document.getElementById('inputMaChiTietDonHang').value.trim();
        if (!maSP || !maCT || isNaN(maCT)) {
            e.preventDefault();
            alert("‚ö† L·ªói: M√£ s·∫£n ph·∫©m ho·∫∑c m√£ chi ti·∫øt ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá!");
        }
    });

    document.querySelectorAll('.star-rating i').forEach(star => {
        star.addEventListener('click', function () {
            let value = this.getAttribute('data-value');
            document.getElementById('inputDanhGia').value = value;
            document.querySelectorAll('.star-rating i').forEach(s => {
                s.classList.remove('bi-star-fill', 'text-warning');
                s.classList.add('bi-star');
            });
            for (let i = 0; i < value; i++) {
                let starEl = document.querySelector(`.star-rating i[data-value="${i+1}"]`);
                starEl.classList.remove('bi-star');
                starEl.classList.add('bi-star-fill', 'text-warning');
            }
        });
    });
</script>
{% endblock %}
